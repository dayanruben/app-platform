
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A lightweight application framework for state and memory management suitable for Kotlin Multiplatform projects.">
      
      
      
        <link rel="canonical" href="https://amzn.github.io/app-platform/scope/">
      
      
        <link rel="prev" href="../module-structure/">
      
      
        <link rel="next" href="../presenter/">
      
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Scope - App Platform</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Fira Code"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Scope - App Platform" >
      
        <meta  property="og:description"  content="A lightweight application framework for state and memory management suitable for Kotlin Multiplatform projects." >
      
        <meta  property="og:image"  content="https://amzn.github.io/app-platform/assets/images/social/scope.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://amzn.github.io/app-platform/scope/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Scope - App Platform" >
      
        <meta  name="twitter:description"  content="A lightweight application framework for state and memory management suitable for Kotlin Multiplatform projects." >
      
        <meta  name="twitter:image"  content="https://amzn.github.io/app-platform/assets/images/social/scope.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scope" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="App Platform" class="md-header__button md-logo" aria-label="App Platform" data-md-component="logo">
      
  <img src="../images/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            App Platform
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Scope
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/amzn/app-platform" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    app-platform
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Introduction

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../setup/" class="md-tabs__link">
        
  
  
    
  
  Setup

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../module-structure/" class="md-tabs__link">
        
  
  
    
  
  Module Structure

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Scope

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../presenter/" class="md-tabs__link">
        
  
  
    
  
  Presenter

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../renderer/" class="md-tabs__link">
        
  
  
    
  
  Renderer

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../template/" class="md-tabs__link">
        
  
  
    
  
  Template

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../di/" class="md-tabs__link">
        
  
  
    
  
  DI Framework

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../testing/" class="md-tabs__link">
        
  
  
    
  
  Testing

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../faq/" class="md-tabs__link">
        
  
  
    
  
  FAQ

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../changelog/" class="md-tabs__link">
        
  
  
    
  
  Changelog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="App Platform" class="md-nav__button md-logo" aria-label="App Platform" data-md-component="logo">
      
  <img src="../images/logo.svg" alt="logo">

    </a>
    App Platform
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/amzn/app-platform" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    app-platform
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../module-structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module Structure
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Scope
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Scope
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-scope" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      Services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coroutinescope" class="md-nav__link">
    <span class="md-ellipsis">
      CoroutineScope
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scoped" class="md-nav__link">
    <span class="md-ellipsis">
      Scoped
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scoped">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#registering-scoped" class="md-nav__link">
    <span class="md-ellipsis">
      Registering Scoped
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onexit" class="md-nav__link">
    <span class="md-ellipsis">
      onExit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threading" class="md-nav__link">
    <span class="md-ellipsis">
      Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hosting-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      Hosting Scopes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hosting Scopes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rootscopeprovider" class="md-nav__link">
    <span class="md-ellipsis">
      RootScopeProvider
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../presenter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Presenter
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../renderer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Renderer
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Template
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../di/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DI Framework
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="scope">Scope<a class="headerlink" href="#scope" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Importing the <code>Scopes</code> API is an opt-in feature through the Gradle DSL. The default value is <code>false</code>.
<div class="highlight"><pre><span></span><code><span class="n">appPlatform</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="n">addPublicModuleDependencies</span><span class="w"> </span><span class="kc">true</span>
<span class="o">}</span>
</code></pre></div></p>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Scopes define the boundary our software components operate in. A scope is a space with a well-defined lifecycle
that can be created and torn down. Scopes host other objects and can bind them to their lifecycle. Sub-scopes
or child scopes have the same or a shorter lifecycle as their parent scope.</p>
<p>A leak happens when one scope references another scope with a different lifecycle, e.g. a background thread,
which is started and finishes after a certain amount of time, references an Android <code>Activity</code> that is being
destroyed while the thread is still running. In this case the thread with the longer lifecycle leaks the
<code>Activity</code> with the shorter lifecycle. Another example is a singleton object, which lives as long as the
application process runs, keeping a strong reference to a user object, which should be released after the
user session expires.</p>
<p>Relying purely on platform specific scopes is problematic, because these scopes are out of our control.
When the platform decides to destroy one of its scopes, then we need to adjust and tear down our operations.
This doesn’t always align with our use cases, e.g. we might want to finish uploading data in the background
after the platform scope such as an <code>Activity</code> has been destroyed. Further, the platform scopes may not align
with how we&rsquo;d represent logical scopes for our apps, e.g. they often lack a user scope. This forces us to
push objects and lifecycles into the application scope and this could cause data to leak across sessions and
trigger out of memory scenarios.</p>
<p>We need to be in charge of our own scopes. In simple terms this means having an object that can be created and
destroyed.</p>
<p>The App Platform provides the
<a href="https://github.com/amzn/app-platform/blob/main/scope/public/src/commonMain/kotlin/software/amazon/app/platform/scope/Scope.kt">Scope</a>
interface to implement this concept.</p>
<div class="highlight"><span class="filename">Scope.kt</span><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">Scope</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">name</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">parent</span><span class="p">:</span><span class="w"> </span><span class="n">Scope?</span>

<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="nf">buildChild</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Builder</span><span class="p">.()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">):</span><span class="w"> </span><span class="n">Scope</span>
<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="nf">children</span><span class="p">():</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Scope</span><span class="o">&gt;</span>

<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="nf">isDestroyed</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span>
<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span>

<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">scoped</span><span class="p">:</span><span class="w"> </span><span class="n">Scoped</span><span class="p">)</span>
<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Any</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getService</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">T?</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="creating-a-scope">Creating a <code>Scope</code><a class="headerlink" href="#creating-a-scope" title="Permanent link">&para;</a></h2>
<p>A <code>Scope</code> is created through the builder function. The
<a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/scope/public/src/commonMain/kotlin/software/amazon/app/platform/scope/Scope.kt#L57">Builder</a>
allows you to add services before the Scope is finalized:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">rootScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scope</span><span class="p">.</span><span class="na">buildRootScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">addService</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Child scopes are created using the parent:</p>
<div class="highlight"><pre><span></span><code><span class="n">rootScope</span><span class="p">.</span><span class="na">buildChild</span><span class="p">(</span><span class="s">&quot;user scope&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">addService</span><span class="p">(</span><span class="s">&quot;child-service&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">childService</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<details class="example">
<summary>Sample</summary>
<p>The root scope is usually created when the application is launched. The sample application creates its
root scope <a href="https://github.com/amzn/app-platform/blob/main/sample/app/src/commonMain/kotlin/software/amazon/app/platform/sample/DemoApplication.kt">here</a>.
This <code>Scope</code> is never destroyed and stays alive for the entire app lifetime.</p>
<p>The sample application has a child scope for the logged in user. This <code>Scope</code> is created during
<a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/user/impl/src/commonMain/kotlin/software/amazon/app/platform/sample/user/UserManagerImpl.kt#L47-L52">login</a>
and <a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/user/impl/src/commonMain/kotlin/software/amazon/app/platform/sample/user/UserManagerImpl.kt#L68">destroyed</a>
during logout.</p>
<div class="highlight"><pre><span></span><code><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">userComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userComponentFactory</span><span class="p">.</span><span class="na">createUserComponent</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">userScope</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">rootScopeProvider</span><span class="p">.</span><span class="na">rootScope</span><span class="p">.</span><span class="na">buildChild</span><span class="p">(</span><span class="s">&quot;user-</span><span class="si">$</span><span class="n">userId</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">addDiComponent</span><span class="p">(</span><span class="n">userComponent</span><span class="p">)</span>
<span class="w">      </span><span class="n">addCoroutineScopeScoped</span><span class="p">(</span><span class="n">userComponent</span><span class="p">.</span><span class="na">userScopeCoroutineScopeScoped</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="p">...</span>

<span class="w">  </span><span class="n">userScope</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">userComponent</span><span class="p">.</span><span class="na">userScopedInstances</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">logout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">currentUserScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">value</span><span class="o">?.</span><span class="na">scope</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">currentUserScope</span><span class="o">?.</span><span class="na">destroy</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>
<p>Tests usually leverage the test scope, which comes with better defaults for services such as the coroutine scope:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`my test`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scope</span><span class="p">.</span><span class="na">buildTestScope</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Or</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`my test`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runTestWithScope</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">  </span><span class="c1">// `scope` is equivalent to calling `Scope.buildTestScope(this)`.</span>
<span class="p">}</span>
</code></pre></div>
<details class="example">
<summary>Sample</summary>
<p>Classes implementing the <code>Scoped</code> interface usually make use of the <code>runTestWithScope</code> function in their tests.
Notice in <a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/user/impl/src/commonTest/kotlin/software/amazon/app/platform/sample/user/SessionTimeoutTest.kt#L36-L48">this sample</a>
how <code>SessionTimeout</code>, which implements the <code>Scoped</code> interface, is registered in the <code>Scope</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`on timeout the user is logged out`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runTestWithScope</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">userManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FakeUserManager</span><span class="p">()</span>
<span class="w">  </span><span class="n">userManager</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="m">1L</span><span class="p">)</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">sessionTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionTimeout</span><span class="p">(</span><span class="n">userManager</span><span class="p">,</span><span class="w"> </span><span class="n">FakeAnimationHelper</span><span class="p">)</span>
<span class="hll"><span class="w">  </span><span class="n">scope</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">sessionTimeout</span><span class="p">)</span>
</span>
<span class="w">  </span><span class="n">assertThat</span><span class="p">(</span><span class="n">userManager</span><span class="p">.</span><span class="na">user</span><span class="p">.</span><span class="na">value</span><span class="p">).</span><span class="na">isNotNull</span><span class="p">()</span>

<span class="w">  </span><span class="n">advanceTimeBy</span><span class="p">(</span><span class="n">SessionTimeout</span><span class="p">.</span><span class="na">initialTimeout</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.</span><span class="n">milliseconds</span><span class="p">)</span>
<span class="w">  </span><span class="n">assertThat</span><span class="p">(</span><span class="n">userManager</span><span class="p">.</span><span class="na">user</span><span class="p">.</span><span class="na">value</span><span class="p">).</span><span class="na">isNull</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h2 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h2>
<p>A scope can host other objects like an object graph from dependency injection frameworks and a coroutine scope.
The latter is especially helpful, because the coroutine scope can be canceled when our logical scope is destroyed
and all pending operations are torn down. Connecting our scopes with the dependency injection components makes
our dependency injection setup more flexible, because we’re in charge of instantiating components and can provide
extra objects like a user ID to the object graph. When a scope is destroyed we release the dependency injection
component and the memory can be reclaimed by the runtime. DI components and subcomponents form a tree, therefore
subcomponents can inject all types that are provided by parent components. The strong recommendation is to align
the component tree with the scope hierarchy.</p>
<p>While a service can be obtained through the <code>getService()</code> function, a more frequent pattern is to rely on
extension functions for stronger types. Similarly, an extension function on the <code>Builder</code> allows us to add a service
to a <code>Scope</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">MyService</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">MY_SERVICE_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myService&quot;</span>

<span class="kd">fun</span><span class="w"> </span><span class="n">Scope</span><span class="p">.</span><span class="nf">Builder</span><span class="p">.</span><span class="na">addMyService</span><span class="p">(</span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="n">MyService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">addService</span><span class="p">(</span><span class="n">MY_SERVICE_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="n">Scope</span><span class="p">.</span><span class="nf">myService</span><span class="p">():</span><span class="w"> </span><span class="n">MyService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">checkNotNull</span><span class="p">(</span><span class="n">getService</span><span class="o">&lt;</span><span class="n">MyService</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MY_SERVICE_KEY</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>The App Platform comes with a coroutine scope service and an integration for
<a href="https://github.com/amzn/kotlin-inject-anvil">kotlin-inject-anvil</a> as dependency injection framework.</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">rootScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scope</span><span class="p">.</span><span class="na">buildRootScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">addDiComponent</span><span class="p">(</span><span class="n">kotlinInjectComponent</span><span class="p">)</span>
<span class="w">  </span><span class="n">addCoroutineScopeScoped</span><span class="p">(</span><span class="n">coroutineScope</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Obtain service.</span>
<span class="n">rootScope</span><span class="p">.</span><span class="na">diComponent</span><span class="o">&lt;</span><span class="n">AbcComponent</span><span class="o">&gt;</span><span class="p">()</span>
<span class="n">rootScope</span><span class="p">.</span><span class="na">coroutineScope</span><span class="p">()</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>Scopes</code> through their service mechanism implement the service locator pattern. With the provided dependency
injection framework usually it’s not needed to add custom services and it’s better to rely on dependency
injection instead.</p>
</div>
<h3 id="coroutinescope"><code>CoroutineScope</code><a class="headerlink" href="#coroutinescope" title="Permanent link">&para;</a></h3>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>By default, the IO dispatcher is used for all launched jobs for the provided <code>CoroutineScope</code>.</p>
<p>In tests when using <code>Scope.buildTestScope()</code> or <code>runTestWithScope</code> the <code>backgroundScope</code> is from the <code>TestScope</code>
is used by default and added to <code>Scope</code> instance.</p>
</div>
<p>It&rsquo;s strongly recommended to add a <code>CoroutineScope</code> to each each <code>Scope</code>. App Platform provides a <code>CoroutineScope</code>
<a href="https://github.com/amzn/app-platform/blob/main/kotlin-inject/impl/src/commonMain/kotlin/software/amazon/app/platform/scope/coroutine/AppScopeCoroutineScopeComponent.kt">by default for the <code>AppScope</code></a>.
It is important to register this <code>CoroutineScope</code> in the created app <code>Scope</code> instance in order to cancel the
<code>CoroutineScope</code> in case the <code>AppScope</code> ever gets destroyed. The same applies to any child scope.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SingleIn</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@MergeComponent</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">interface</span><span class="w"> </span><span class="nc">AppComponent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/** The coroutine scope that runs as long as the app scope is alive. */</span>
<span class="w">  </span><span class="nd">@ForScope</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">appScopeCoroutineScopeScoped</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineScopeScoped</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">createAppScope</span><span class="p">(</span><span class="n">appComponent</span><span class="p">:</span><span class="w"> </span><span class="n">AppComponent</span><span class="p">):</span><span class="w"> </span><span class="n">Scope</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Scope</span><span class="p">.</span><span class="na">buildRootScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">addDiComponent</span><span class="p">(</span><span class="n">appComponent</span><span class="p">)</span>
<span class="w">    </span><span class="n">addCoroutineScopeScoped</span><span class="p">(</span><span class="n">appComponent</span><span class="p">.</span><span class="na">appScopeCoroutineScopeScoped</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li><code>CoroutineScopeScoped</code> wraps a <code>CoroutineScope</code> in a <code>Scoped</code> instance. In <code>onExitScope()</code> of this instance the
    <code>CoroutineScope</code> will be canceled.</li>
</ol>
<p>The <code>CoroutineScope</code> can be injected in classes and used to launch async work. A common pattern is to use the
<code>onEnterScope()</code> function to launch coroutine jobs:</p>
<div class="highlight"><pre><span></span><code><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// This job will be automatically canceled when the `scope` gets destroyed.</span>
<span class="w">  </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="w">    </span><span class="n">someFlow</span><span class="p">.</span><span class="na">collect</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li><code>scope.launch</code> is a convenience function for <code>scope.coroutineScope().launch</code>.</li>
</ol>
<p>Since the <code>CoroutineScope</code> is part of the <code>kotlin-inject-anvil</code> object graph, the <code>CoroutineScope</code> can be injected
in the constructor as well:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Inject</span>
<span class="nd">@SingleIn</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="nd">@ForScope</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="n">coroutineScope</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">init</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">coroutineScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Whenever a <code>CoroutineScope</code> is injected, a new child <code>CoroutineScope</code> with its own <code>Job</code> is created (the parent <code>Job</code>
points to the shared <code>CoroutineScope</code> <code>Job</code>). The prevents consumers from accidentally tearing down all running
coroutines when canceling an injected <code>CoroutineScope</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">myCoroutineScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scope</span><span class="p">.</span><span class="na">coroutineScope</span><span class="p">()</span>

<span class="w">  </span><span class="n">myCoroutineScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">myCoroutineScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// This is safe to do and only cancels the two launched jobs and `myCoroutineScope`. It doesn&#39;t cancel the</span>
<span class="w">  </span><span class="c1">// shared `CoroutineScope` hosted within the `scope` object.</span>
<span class="w">  </span><span class="n">myCoroutineScope</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="scoped"><code>Scoped</code><a class="headerlink" href="#scoped" title="Permanent link">&para;</a></h2>
<p>Service objects can tie themselves to the lifecycle of a scope by implementing the
<a href="https://github.com/amzn/app-platform/blob/main/scope/public/src/commonMain/kotlin/software/amazon/app/platform/scope/Scoped.kt"><code>Scoped</code></a>
interface:</p>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">Scoped</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onExitScope</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>Usually, we rely on our dependency injection framework to instantiate all <code>Scoped</code> instances for a scope. By doing
so service objects will be automatically created when their corresponding scope is created and receive a callback
when their scope is destroyed. This helps with loose coupling between our service objects. Implementing the <code>Scoped</code>
interface is a detail, which doesn’t need to be exposed to the API layer:</p>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">LocationProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">location</span><span class="p">:</span><span class="w"> </span><span class="n">StateFlow</span><span class="o">&lt;</span><span class="n">Location</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="hll"><span class="kd">class</span><span class="w"> </span><span class="nc">AndroidLocationProvider</span><span class="p">(</span>
</span><span class="hll"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">locationManager</span><span class="p">:</span><span class="w"> </span><span class="n">LocationManager</span>
</span><span class="hll"><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">LocationProvider</span><span class="p">,</span><span class="w"> </span><span class="n">Scoped</span><span class="w"> </span><span class="p">{</span>
</span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">_location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MutableStateFlow</span><span class="o">&lt;</span><span class="n">Location</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">location</span><span class="w"> </span><span class="k">get</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_location</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Observe location updates through LocationManager</span>

<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="nv">androidLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="w">      </span><span class="n">_location</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">androidLocation</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note in the example that the concrete implementation class implements the <code>Scoped</code> interface and
not <code>LocationProvider</code>. Being lifecycle aware is an implementation detail.</p>
</div>
<p>How the <code>Scoped</code> object is instantiated depends on the dependency injection framework and which scope to use.
With <code>kotlin-inject-anvil</code> for the app scope it would be:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Inject</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="nd">@SingleIn</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)!</span>
<span class="nd">@ContributesBinding</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="c1">//(3)!</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">AndroidLocationProvider</span><span class="p">(</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">LocationProvider</span><span class="p">,</span><span class="w"> </span><span class="n">Scoped</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>This annotation is required to support constructor injection.</li>
<li>This annotation ensures that there is only ever a single instance of <code>AndroidLocationProvider</code> in the <code>AppScope</code>.</li>
<li>This annotation ensures that when somebody injects <code>LocationProvider</code>, then they get the singleton instance of <code>AndroidLocationProvider</code>.</li>
</ol>
<details class="note">
<summary><code>@ContributesBinding</code> will generate and contribute bindings</summary>
<p>The <code>@ContributesBinding</code> annotation will generate a component interface with bindings for <code>LocationProvider</code>
and <code>Scoped</code>. The generated interface will be added automatically to the <code>AppScope</code>. No further manual step
is needed.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Provides</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">provideAndroidLocationProvider</span><span class="p">(</span><span class="n">androidLocationProvider</span><span class="p">:</span><span class="w"> </span><span class="n">AndroidLocationProvider</span><span class="p">):</span><span class="w"> </span><span class="n">LocationProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">androidLocationProvider</span>

<span class="nd">@Provides</span>
<span class="nd">@IntoSet</span>
<span class="nd">@ForScope</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">provideAndroidLocationProviderScoped</span><span class="p">(</span><span class="n">androidLocationProvider</span><span class="p">:</span><span class="w"> </span><span class="n">AndroidLocationProvider</span><span class="p">):</span><span class="w"> </span><span class="n">Scoped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">androidLocationProvider</span>
</code></pre></div>
</details>
<details class="example">
<summary>Sample</summary>
<p>Another example in the sample app is <a href="https://github.com/amzn/app-platform/blob/main/sample/user/impl/src/commonMain/kotlin/software/amazon/app/platform/sample/user/SessionTimeout.kt"><code>SessionTimeout</code></a>.
This class is part of the <code>UserScope</code> and implements the <code>Scoped</code> interface. <code>onEnterScope()</code> will be called when
the user logs in and <code>onExitScope()</code> when the user logs out.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Inject</span>
<span class="nd">@SingleIn</span><span class="p">(</span><span class="n">UserScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@ContributesBinding</span><span class="p">(</span><span class="n">UserScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">SessionTimeout</span><span class="p">(...)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Scoped</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// This job will be automatically canceled when the user logs out and the user scope is</span>
<span class="w">    </span><span class="c1">// destroyed.</span>
<span class="w">    </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">userManager</span><span class="p">.</span><span class="na">user</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h3 id="registering-scoped">Registering <code>Scoped</code><a class="headerlink" href="#registering-scoped" title="Permanent link">&para;</a></h3>
<p>The dependency injection framework like <code>kotlin-inject-anvil</code> is only responsible for creating <code>Scoped</code> instances,
but it doesn&rsquo;t automatically register them in the <code>Scope</code>. This has to be done whenever the <code>Scope</code> is created:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SingleIn</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@MergeComponent</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">interface</span><span class="w"> </span><span class="nc">AppComponent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/** All [Scoped] instances part of the app scope. */</span>
<span class="hll"><span class="w">  </span><span class="nd">@ForScope</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">appScopedInstances</span><span class="p">:</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Scoped</span><span class="o">&gt;</span>
</span><span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">createAppScope</span><span class="p">(</span><span class="n">appComponent</span><span class="p">:</span><span class="w"> </span><span class="n">AppComponent</span><span class="p">):</span><span class="w"> </span><span class="n">Scope</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">rootScope</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">Scope</span><span class="p">.</span><span class="na">buildRootScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">addDiComponent</span><span class="p">(</span><span class="n">appComponent</span><span class="p">)</span>

<span class="w">      </span><span class="n">addCoroutineScopeScoped</span><span class="p">(</span><span class="n">appComponent</span><span class="p">.</span><span class="na">appScopeCoroutineScopeScoped</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="hll"><span class="w">  </span><span class="n">rootScope</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">appComponent</span><span class="p">.</span><span class="na">appScopedInstances</span><span class="p">)</span>
</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">rootScope</span>
<span class="p">}</span>
</code></pre></div>
<p>By calling <code>appComponent.appScopedInstances</code> the DI framework instantiates all <code>Scoped</code> instances part of the
<code>AppScope</code>. The <code>rootScope.register(...)</code> call will register all of the <code>Scoped</code> instances and invoke
<code>onEnterScope(scope)</code>. When calling <code>rootScope.destroy()</code> later at some point, then <code>onExitScope()</code> will be
called for all <code>Scoped</code> instances.</p>
<details class="example">
<summary>Sample</summary>
<p>The sample application implements this mechanism for the
<a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/app/src/commonMain/kotlin/software/amazon/app/platform/sample/DemoApplication.kt#L31-L33"><code>AppScope</code></a>
and the <a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/user/impl/src/commonMain/kotlin/software/amazon/app/platform/sample/user/UserManagerImpl.kt#L58-L60"><code>UserScope</code></a>.</p>
</details>
<h3 id="onexit"><code>onExit</code><a class="headerlink" href="#onexit" title="Permanent link">&para;</a></h3>
<p>The convenience function <code>onExit</code> is handy when you want to create objects lazily within <code>onEnterScope()</code> and
not create a property in the class itself. This callback notifies you when the <code>Scope</code> is destroyed similar to
<code>onExitScope()</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Inject</span>
<span class="nd">@SingleIn</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@ContributesBinding</span><span class="p">(</span><span class="n">AppScope</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">application</span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Scoped</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">object</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BroadcastReceiver</span><span class="p">()</span>

<span class="w">    </span><span class="n">application</span><span class="p">.</span><span class="na">registerReceiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="p">())</span>

<span class="w">    </span><span class="n">scope</span><span class="p">.</span><span class="na">onExit</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// This function is invoked when the scope gets destroyed.</span>
<span class="w">      </span><span class="n">application</span><span class="p">.</span><span class="na">unregisterReceiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="threading">Threading<a class="headerlink" href="#threading" title="Permanent link">&para;</a></h3>
<p>Which thread is used for calling <code>onEnterScope()</code> and <code>onExitScope()</code> is an implementation detail of the scope
owner when calling <code>scope.register(Scoped)</code>. Usually, the app scope is created as soon as possible when the
application launches and therefore the main thread is used. Child scopes may use the main thread or a background
thread.</p>
<p>To safely launch long running work or blocking tasks it’s recommended to use the coroutine scope provided by the
<code>Scope</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onEnterScope</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Clean up routines in <code>onExitScope()</code> must be blocking, otherwise these tasks live longer than the <code>Scope</code> and
therefore may cause a leak (thread and memory) and potential race conditions. It’s strongly recommended not to
launch any asynchronous work within <code>onExitScope()</code>. By the time <code>onExitScope()</code> is called, the coroutine
scope provided by the <code>Scope</code> has been canceled already.</p>
<h2 id="hosting-scopes">Hosting <code>Scopes</code><a class="headerlink" href="#hosting-scopes" title="Permanent link">&para;</a></h2>
<p>Scopes need to be remembered and must be accessible in order to get access to their services. Where to host scopes
depends on what scopes are required and when they need to be created. Most apps have some form of an application
scope, which is a singleton scope for the entire lifetime of the application. A natural place to host this scope
for Android apps is within the <code>Application</code> class, for iOS apps within <code>App</code> struct or the main function
for desktop applications.</p>
<p>A user scope has a shorter lifecycle than the application scope, but usually lives longer than UI components.
It is commonly hosted by a service object managing the login state. This scope is destroyed after the user
session expires.</p>
<p>App Platform by default only provides the <code>AppScope</code>, which has to be manually created by each application as
highlighted above.</p>
<details class="example">
<summary>Sample</summary>
<p>The sample application has a common class <a href="https://github.com/amzn/app-platform/blob/main/sample/app/src/commonMain/kotlin/software/amazon/app/platform/sample/DemoApplication.kt">DemoApplication</a>
that is responsible for creating the app scope. The Android app instantiates <code>DemoApplication</code> in the
<a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/app/src/androidMain/kotlin/software/amazon/app/platform/sample/AndroidApplication.kt#L19"><code>Application</code> class</a>.
The iOS sample creates the <code>DemoApplication</code> in the <a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/iosApp/iosApp/iOSApp.swift#L6"><code>UIApplicationDelegate</code></a>.
On Desktop <code>DemoApplication</code> is created part of the <a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/app/src/desktopMain/kotlin/software/amazon/app/platform/sample/Main.kt#L8"><code>main()</code> function</a>.</p>
</details>
<h3 id="rootscopeprovider"><code>RootScopeProvider</code><a class="headerlink" href="#rootscopeprovider" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/amzn/app-platform/blob/main/scope/public/src/commonMain/kotlin/software/amazon/app/platform/scope/RootScopeProvider.kt"><code>RootScopeProvider</code></a>,
as the name suggests, gives access to the root <code>Scope</code> (&ldquo;AppScope&rdquo;). Usually, this interface is implemented by the application
object of the individual platform to get access to the root <code>Scope</code> from a platform context, e.g. on Android this is
handy in an <code>Activity</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MainActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Activity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">rootScopeProvider</span>
<span class="w">    </span><span class="k">get</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">RootScopeProvider</span>

<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<details class="example">
<summary>Sample</summary>
<p>The sample application implements <code>RootScopeProvider</code> in the Android
<a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/app/src/androidMain/kotlin/software/amazon/app/platform/sample/AndroidApplication.kt#L19"><code>Application</code> class</a>
and the iOS <a href="https://github.com/amzn/app-platform/blob/0f3e242ae08bb242fbd7080d33caa069c8fae2b4/sample/iosApp/iosApp/iOSApp.swift#L6"><code>UIApplicationDelegate</code></a>.
On Desktop there is no concept of a singleton application object by default, but in the sample app we created an
equivalent with <a href="https://github.com/amzn/app-platform/blob/main/sample/app/src/desktopMain/kotlin/software/amazon/app/platform/sample/DesktopApp.kt"><code>DesktopApp</code></a>.</p>
</details>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "toc.follow", "toc.integrate", "content.tabs.link"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>